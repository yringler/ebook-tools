This is a complete mess and has to be rewritten.
On the plus side, the functionality is here (I think)...but has to be
completely reorginized
